<!-- http://demos.jquerymobile.com/1.4.4/listview-autocomplete-remote/      data-dom-cache="true"-->
<div data-role="page" id="page_taskes_search_pole" >
	<style type="text/css">
		.ui-filter-inset {
			margin-top: 0;
		}
    </style>
	<div data-role="header"  data-position="fixed">
    	<a href="#page_taskes_new" class="ui-btn ui-corner-all"  data-theme="c">返回</a>
        <h1>搜索点位</h1> 
	</div>
	<div role="main" class="ui-content">
        <form class="ui-filterable">
        <table>
        	<tr>
            	<td width="100%"><input id="page_taskes_search_pole_input" data-type="search" placeholder="请输入点位编号或名称" ></td>
                <td width="60"><a href="#" id="page_taskes_search_pole_button" class="ui-shadow ui-btn ui-corner-all ui-btn-inline" style="float:left;">搜索</a></td>
            </tr>
        </table>
        </form>
        <ul id="page_taskes_search_pole_autocomplete" data-role="listview" data-inset="true" data-input="#page_taskes_search_pole_input">
        </ul>
	</div>
    <script type="application/javascript">
	function changePole(pole_id,pole_name,pole_address,pole_status){
		//page_taskes_new_type是在taskes.html中定义的
		var params=window.page_taskes_new_params;
		if(params.type=="newInstall" && pole_status!="uninstall"){
			alert("点位‘"+pole_name+"’不能发送新安装任务!");
			return;
		} else if(params.type=="repairs" && pole_status!="using" && pole_status!="hitch"){
			alert("只有'使用中','有损坏'状态的点位，才能发送维修/维护任务!");
			return;
		} else if(params.type=="patrol" && pole_status!="using" && pole_status!="hitch"){
			alert("只有'使用中','有损坏'状态的点位，才能发送巡检任务!");
			return;
		}
		params.pole_id=pole_id,
		params.pole_name=pole_name,
		params.pole_address=pole_address
		$(document).pagecontainer( "load" );
		
	} 
	</script>
    <script type="application/javascript">
	$(document).ready(function(e) {
		$( document ).on( "pagecreate", "#page_taskes_search_pole", function() {
			//$( "#page_taskes_search_pole_autocomplete" ).on( "filterablebeforefilter", function ( e, data ) {
				//var $ul = $( this );
				//var	$input = $( data.input )
			$( "#page_taskes_search_pole_button" ).on( "click", function ( e, data ) {
				var $ul = $( "#page_taskes_search_pole_autocomplete" );
				var	$input = $("#page_taskes_search_pole_input")
				var	value = $input.val()
				var	html = "";
				$ul.html( "" );
				if ( value && value.length >= 3 ) {
					$.showLoader();
					$.ajax({
						url:$.ServerPath+"/task/mobile/queryPoles.do",
						data: {
							pole_name: $input.val()
						}
					})
					.then( function ( response ) {
						var root=response.root;
						if(!root || root.length==0){
							$ul.html( "<li>无匹配点位</li>" );
							$ul.listview( "refresh" );
							$.hideLoader();
							return;
						}
						for(var i=0;i<root.length;i++){
							html += "<li data-filtertext='"+root[i].name+" "+root[i].address+"'>"+
							"<a href='#page_taskes_new' onClick='changePole(\""+root[i].id+"\",\""+root[i].name+"\",\""+root[i].address+"\",\""+root[i].status+"\");'>" + root[i].name +
							'<p>'+root[i].code+'</p>'+
							 "<p>"+root[i].address+"</p></a></li>";
						}
						$ul.html(html );
						$ul.listview( "refresh" );
						$ul.trigger( "updatelayout");
						$.hideLoader();
					});
				} else {
					alert("请至少输入3个字符!");
					return;
				}	
			});
			
			 
		});//pagecreate
	});//ready
</script>
</div>
