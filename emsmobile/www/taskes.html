<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<title>任务列表</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="cordova.js"></script>
<link href="jquery.mobile/jquery.mobile-1.4.3.min.css" rel="stylesheet" type="text/css"/>
<script src="jquery.mobile/jquery-2.1.1.min.js" type="text/javascript"></script>
<script src="jquery.mobile/jquery.mobile-1.4.3.min.js" type="text/javascript"></script>
<script src="js/main.js" type="text/javascript"></script>
<style type="text/css">
.secondNavbar-glyphish-example .ui-btn { padding-top: 40px !important; }
.secondNavbar-glyphish-example .ui-btn:after { width: 34px!important; height: 34px!important; margin-left: -15px !important; box-shadow: none!important; -moz-box-shadow: none!important; -webkit-box-shadow: none!important; -webkit-border-radius: 0 !important; border-radius: 0 !important; }
.ui-icon-install:after {
    background-image: url("img/install.png");
    /* Make your icon fit */
    background-size: 34px 34px;
	background-color:#f6f6f6;
}
.ui-icon-repair:after {
    background-image: url("img/repair.png");
    /* Make your icon fit */
    background-size: 34px 34px;
	background-color:#f6f6f6;
}
.ui-icon-patrols:after {
    background-image: url("img/patrols.png");
    /* Make your icon fit */
    background-size: 34px 34px;
	background-color:#f6f6f6;
}


/**
#popupNewTaskDialog {
  width: 100%;
  max-width: 500px;
  margin: 10% auto 15px auto;
  padding: 0;
  position: relative;
  top: -15px;
}

#popupNewTaskDialog {
    position: relative;
    left: 50%;
    width: 6em;
    margin-left: -3em;
    background-color: #ffa0a0;
    border-color: black;
}
*/

#fullbg {
    background-color:Gray;
    left:0px;
    opacity:0.5;
    position:absolute;
    top:0px;
    z-index:100;
    filter:alpha(opacity=50); /* IE6 */
    -moz-opacity:0.5; /* Mozilla */
    -khtml-opacity:0.5; /* Safari */
}

.taskes_list_display_none{
	display:none;
}
.taskes_list_display_block{
	display:block;
}
</style>
<script type="application/javascript">

var secondNavbarIsHide=true;
function toggleSecondNavbar(){	
	$("#secondNavbar").toggle(500,function(){
		secondNavbarIsHide=!secondNavbarIsHide;
	});
	if(secondNavbarIsHide){
		var footernavZIndex=$("#footernav").css("z-index");
		$("#footernav").css("z-index","50");
		//$("#footernav").css("z-index","50");
		showBg();	
		$("#dialog").show();//显示二级菜单
	} else {
		$("#footernav").css("z-index",footernavZIndex);
		closeBg();
	}
}

//显示灰色 jQuery 遮罩层
function showBg(fullScreen) {
    var bh = $("body").height();
    var bw = $("body").width();
    $("#fullbg").css({
        height:bh,
        width:bw,
		top:fullScreen?$("#page_homepage_header").height():0,
		//zIndex:2500,
        display:"block"
    });
    
}
//关闭灰色 jQuery 遮罩
function closeBg() {
    $("#fullbg").hide();
}


var pageParam={
	start:0,
	limit:20
}
//查询任务
//appendDir:append表示是要加在现有数据后面的，prepend在开头插入数据，用在定时刷新上
function queryTasks(status,appendDir,callBack){
	
	$.ajax({   
		url : $.ServerPath+"/task/mobile/query.do",  
		data:{start:pageParam.start,limit:pageParam.limit,status:status},  
		success : function(data){
			if(data.success==true){
				var root=data.root;
				var html="";
				for(var i=0;i<root.length;i++){
					var taskInfoParamStr='?id='+root[i].id+'&pole_name='+root[i].pole_name+'&memo='+root[i].memo+'&type='+root[i].type+'&canEdit='+(status=="working"?true:false);
					//alert(taskInfoParamStr);
					var page_id="";
					var h2_title="";
					var img="";
					if("newInstall"==root[i].type){
						page_id="page_install";
						h2_title="新安装";
						img="img/install.png";
					} else if("repair"==root[i].type){
						page_id="page_repair";
						h2_title="维修/维护";
						img="img/repair.png";
					} else if("patrol"==root[i].type){
						page_id="page_patrol";
						h2_title="巡检";
						img="img/patrols.png";
					}
					html+='<li id="li_'+root[i].id+'">'+
					'<a href="#'+page_id+'" onclick="sessionStorage.taskInfoParamStr=\''+taskInfoParamStr+'\'" data-transition="slide" >'+
						'<img src="'+img+'">'+
						'<h2>'+h2_title+':'+root[i].pole_name+'</h2>'+
						'<p>地址:'+root[i].pole_address+'</p>'+
						'<p class="ui-li-aside"><strong>'+root[i].createDate+'</strong></p>'+
						((root[i].status!="newTask")?'':'<p class="ui-li-count" style="color:#FFF;background-color:#F00;">new</p>')+
					'</a>'+
					'</li>'
				}
				if(appendDir=="append"){
					$("#taskes_list_"+status).append(html).listview('refresh');
				} else if(appendDir=="prepend"){
					$("#taskes_list_"+status).prepend(html).listview('refresh');
				} else {
					$("#taskes_list_"+status).html(html).listview('refresh');
				}
				//下次开始获取的数据
				pageParam.start=pageParam.start+root.length;
				
			}else{
				//$("#errorMsg").html(data.reasons.reason);
			}
			 
			if(callBack){
				callBack();
			}
			},
			error:function(jqxhq){  
				$("#errorMsg").html('网络异常或服务停止了');  
				if(callBack){
					callBack();
				}
			}  
	});
}
//切换任务状态框
var taskes_list_query_status={
	working:false,
	'confirm':false,
	complete:false
};
function changeTaskesStatus(status){
	$("ul[id^='taskes_list_']").removeClass("taskes_list_display_block").addClass("taskes_list_display_none");
	$("#taskes_list_"+status).addClass("taskes_list_display_block");
	//如果数据已经查询过了，就不再查询了
	if(!taskes_list_query_status[status]){
		$.showLoader("正在加载....");
		queryTasks(status,null,function(){
			$.hideLoader();
			window.isLazyLoading=false;
		});
		taskes_list_query_status[status]=true;
	}
	
}
$(document).ready(function(e) {
	//---初始化任务信息
	var status=$("input:checked[name='radio-choice-taskes-status']").val();
	changeTaskesStatus(status);
	$("input[name=radio-choice-taskes-status]").click(function(e){
	    //var val=$("input:checked[name='radio-choice-taskes-status']").val();
	    //当选择条件发生变化的时候
		
	    status=$(e.target).val();
		changeTaskesStatus(status);
	});
	//到底部的时候去加在最新的数据
	window.isLazyLoading=true;//防止二次刷新,设置为true是防止只有一个页面数据的时候，两次查询
	$(window).scroll(function(){
	if(!window.isLazyLoading&&($(window).scrollTop()==$(document).height()-$(window).height())){
		window.isLazyLoading=true;
		queryTasks(status,"append",function(){
			window.isLazyLoading=false;
			$.hideLoader(); 
		});
	}
	});
	//定时刷新任务,定时更新数据
	setInterval(function(){
		//$.showLoader("正在加载....");
		queryTasks("working","prepend",function(){
			//$.hideLoader();
		});
	 }, "600000");
	
	//初始化滑出菜单
	htmlobj=$.ajax({url:"leftMenu.html",async:false});
  	$("#left-menu-contanier").html(htmlobj.responseText).trigger('create');

});
</script>


</head> 
<body> 

<div data-role="page" id="page_homepage">
	<div id="page_homepage_header" data-role="header" data-position="fixed" data-theme="f" >
        <a href="#left-menu" data-icon="gear" data-iconpos="notext"></a> 
        <div id="left-menu-contanier"></div>
        <div  data-role="controlgroup" data-type="horizontal" align="center" >
            <input type="radio" name="radio-choice-taskes-status" id="radio-choice-taskes-statusa" value="working" checked="checked">
            <label for="radio-choice-taskes-statusa">当前</label>
            <input type="radio" name="radio-choice-taskes-status" id="radio-choice-taskes-statusb" value="confirm">
            <label for="radio-choice-taskes-statusb">确认中</label>
            <input type="radio" name="radio-choice-taskes-status" id="radio-choice-taskes-statusc" value="complete">
            <label for="radio-choice-taskes-statusc">已完成</label>
        </div>
        <!--<a href="#" data-icon="plus" data-iconpos="notext" data-ajax="false"></a>-->
        <button href="#" data-icon="plus" data-iconpos="notext" onClick="toggleSecondNavbar();"></button>
		<div data-role="navbar" id="secondNavbar" class="secondNavbar-glyphish-example" style="display:none;">
        	<ul>
            	<li><a href="#"  class="ui-icon-install ui-btn-icon-top">新安装</a></li>
                <li><a href="#" class="ui-icon-repair ui-btn-icon-top">维修</a></li>
                <li><a href="#" class="ui-icon-patrols ui-btn-icon-top">巡检</a></li>
            </ul>
        </div>
    </div>
	<div role="main" class="ui-content" id="page_content">
		<ul data-role="listview" id="taskes_list_working">
        </ul> 
        
        <ul data-role="listview" id="taskes_list_confirm" > 
        </ul> 
        <ul data-role="listview" id="taskes_list_complete"> 
        </ul>
	</div>
    <!-- jQuery 遮罩层 -->
	<div id="fullbg"  onClick="toggleSecondNavbar();"></div>
    
    
	<div data-role="footer" id="footernav"  data-id="footernav" data-position="fixed" data-tap-toggle="false">
		<div data-role="navbar">  
            <ul>  
                <li><a href="messages.html"  data-icon="mail" data-ajax="false" data-transition="slide">消息提醒</a></li>  
                <li><a href="taskes.html" data-icon="bullets" data-ajax="false" data-transition="slide" class="ui-btn-active ui-state-persist" >任务列表</a></li>  
                <li><a href="others.html" data-icon="star" data-ajax="false" data-transition="slide">其他</a></li>  
            </ul>  
        </div>  
	</div>
</div>


<div data-role="page" id="page_install">
	<div data-role="header">
    	<a href="#page_homepage" class="ui-btn ui-corner-all" data-rel="back" data-theme="c">返回</a>
        <h1>设备新安装</h1> 
	</div>
	<div role="main" class="ui-content">
        <div class="ui-field-contain">
            <label for="id">任务编号:</label>
            <input type="text"  id="page_install_id" placeholder="只读" value="">
            <label for="pole">杆位:</label>
            <input readonly type="text" id="page_install_pole_name" placeholder="只读" value="">
        	<label  for="memo">任务描述:</label>
    		<textarea readonly id="page_install_memo" placeholder="只读" data-mini="true"></textarea>
         </div>	
         <a href="#" class="ui-btn ui-corner-all actionbutton"  id="page_install_scan_button" name="scan_button">扫描新设备</a>
         <input type="text" id="page_install_scan_textfield" class="actionbutton" name="scan_textfield"  value="" placeholder="请扫描或手动输入...">
         <div id="page_install_equipments_list">
         	
          </div>
          <!--
            <textarea cols="40" rows="8" name="textarea" id="textarea" placeholder="请填写设备安装描述"></textarea>
         -->
         <div class="ui-field-contain actionbutton"  align="center">
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="saveTask">保存</button>
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="submitTask">提交</button>
         </div>
	</div>
    <script type="text/javascript">

	</script>
    <div data-role="popup" id="popupArrow" data-arrow="b" data-theme="b">
        <a href="javascript:void(0);" data-role="button" name="deleteEquipmentInfo">删除</a>
    </div>
</div>

<div data-role="page" id="page_repair">
	<div data-role="header">
    	<a href="#page_homepage" class="ui-btn ui-corner-all" data-rel="back" data-theme="c">返回</a>
        <h1>设备维修/维护</h1> 
	</div>
	<div role="main" class="ui-content">
        <div class="ui-field-contain">
            <label for="id">任务编号:</label>
            <input type="text"  id="page_repair_id" placeholder="只读" value="">
            <label for="pole">杆位:</label>
            <input readonly type="text" id="page_repair_pole_name" placeholder="只读" value="">
        	<label  for="memo">任务描述:</label>
    		<textarea readonly  id="page_repair_memo" placeholder="只读" data-mini="true"></textarea>
         </div>	
         <select name="select-choice-a" id="select-choice-a" data-native-menu="false">
        	<option>请选择故障类型</option>
            <option value="standard">摄像头遮挡</option>
            <option value="rush">设备损坏</option>
        </select>

        <select name="select-choice-a" id="select-choice-b" data-native-menu="false">
        	<option>请选择原因模板</option>
            <option value="standard">YYYYYY</option>
            <option value="rush">YY</option>
        </select>
        <textarea  name="textarea" id="textarea" placeholder="请填写设备故障原因情况"></textarea>
         <a href="#" class="ui-btn ui-corner-all actionbutton" name="scan_button">扫描设备</a>
         <input type="text" name="scan_textfield" class="actionbutton"  value="" placeholder="请扫描或手动输入...">
         <div id="page_repair_equipments_list">
         	
          </div>
         <div class="ui-field-contain actionbutton"  align="center">
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="saveTask">保存</button>
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="submitTask">提交</button>
         </div>
	</div>
    <script type="text/javascript">

	</script>
    <div data-role="popup" id="page_repair_deleteEquipmentInfo_popup" data-arrow="b" data-theme="b">
        <a href="javascript:void(0);" data-role="button" name="deleteEquipmentInfo">删除</a>
    </div>
</div>

<div data-role="page" id="page_patrol">

	<div data-role="header">
    	<a href="#page_homepage" class="ui-btn ui-corner-all" data-rel="back" data-theme="c">返回</a>
        <h1>巡检</h1> 
	</div>
	<div role="main" class="ui-content">
        <div class="ui-field-contain">
            <label for="id">任务编号:</label>
            <input type="text"  id="page_patrol_id" placeholder="只读" value="">
            <label for="pole">杆位:</label>
            <input readonly type="text" id="page_patrol_pole_name" placeholder="只读" value="">
        	<label  for="memo">任务描述:</label>
    		<textarea readonly  id="page_patrol_memo" placeholder="只读" data-mini="true"></textarea>
         </div>	
         <a href="#" class="ui-btn ui-corner-all actionbutton" name="scan_button">扫描设备</a>
         <input type="text" name="scan_textfield" class="actionbutton"  value="" placeholder="请扫描或手动输入...">
         <div id="page_patrol_equipments_list">
         	
          </div>
         <div class="ui-field-contain actionbutton"  align="center">
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="saveTask">保存</button>
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="submitTask">提交</button>
         </div>
	</div>
    <script type="text/javascript">

	</script>
    <div data-role="popup" id="page_patrol_deleteEquipmentInfo_popup" data-arrow="b" data-theme="b">
        <a href="javascript:void(0);" data-role="button" name="deleteEquipmentInfo">删除</a>
    </div>
</div>

<script type="application/javascript">
$(document).ready(function(e) {
	
	$( document).on( "pagecontainershow", function( event, ui ) {
		
		if (sessionStorage.taskInfoParamStr!='null') {
			var page_id=ui.toPage.attr("id");
			//从url中解析参数  
			var params = $.getUrlParam(sessionStorage.taskInfoParamStr);  
			window.taskInfoParam=params;
			taskInfoParam.page_id=page_id; 
			//alert(params.canEdit);
			if(params.canEdit=="true"){//隐藏按钮
				$(".actionbutton").show();
			} else {
				$(".actionbutton").hide();
			}
			$("#"+page_id+"_id").val(params.id);  
			$("#"+page_id+"_pole_name").val(params.pole_name);  
			$("#"+page_id+"_memo").val(params.memo);
			sessionStorage.taskInfoParamStr=null;
			//初始化设备列表信息
			queryTaskEquipmentInfos(params.id);
			
			
		}  	
	});
	
	function saveTask(){
		$.showLoader("正在保存....");
		
		//var params="&task_id="+$("#page_install_id").val();
		var params="&task_id="+taskInfoParam.id;
		var page_id=taskInfoParam.page_id;
		$("#"+page_id+"_equipments_list [data-role='collapsible']").each(function(index, element) {
            //values.push($(this).attr("ecode"));
			params+="&ecodes="+$(this).attr("ecode");
        });
		/****/
		$.ajax({   
			url : $.ServerPath+"/task/mobile/save.do",  
			data:params,  
			success : function(data){
				if(data.success==true){	
					
				}
				$.hideLoader();  
			}
		});	
	}
	function submitTask(){
		$.showLoader("正在提交....");

		//var params="&task_id="+$("#page_install_id").val();
		var params="&task_id="+taskInfoParam.id+"&task_type="+taskInfoParam.type;
		var page_id=taskInfoParam.page_id;
		$("#"+page_id+"_equipments_list [data-role='collapsible']").each(function(index, element) {
			params+="&ecodes="+$(this).attr("ecode");
        });
		/****/
		$.ajax({   
			url : $.ServerPath+"/task/mobile/submit.do",  
			data:params,  
			success : function(data){
				if(data.success==true){	
					//var previous = $(':mobile-pagecontainer').pagecontainer( "getActivePage" ).prev('[data-role=page]');
					$.mobile.changePage("#page_homepage", { 
						  transition: 'slide',
						  reverse: true });
					//并且刷新任务,或者移除该任务
					//changeTaskesStatus("working");
					$('#li_'+taskInfoParam.id).remove();
				}
				$.hideLoader();  
			}
		});	
	}

	//渲染设备列表
	function renderEquipmentInfo(obj,coverHtml){
		var html="";
		var root=obj;
		if(!(obj instanceof Array)){
			root=[obj];
		} 
		
		for(var i=0;i<root.length;i++){
			//如果设备状态是手持，就是安装，如果是using就是维修或者巡检，巡检任务扫描的设备都是巡检
			html+='<div data-role="collapsible" ecode="'+root[i].ecode+'">'+
				'<h4>'+root[i].ecode+':'+root[i].style+'</h4>'+
				'<p>'+root[i].brand_name+':'+root[i].subtype_name+'>'+root[i].prod_name+'>'+root[i].supplier_name+'</p>'+
				'</div>';	
		}
		var page_id=taskInfoParam.page_id;
		if(coverHtml){
			//覆盖已经有的html
			$("#"+page_id+"_equipments_list").html(html).enhanceWithin();
		} else {
			$("#"+page_id+"_equipments_list").append(html).enhanceWithin();
		}
		//.html(html);//.enhanceWithin()
		$("#"+page_id+"_equipments_list [data-role='collapsible']").bind( "taphold", function(event){
			window.equipmentInfoCollapsible=event.target;
			//$( "#popupArrow" ).popup( "open", { positionTo:event.target,transition: "pop" } );
			$( "#"+page_id+"_deleteEquipmentInfo_popup" ).popup( "open", { positionTo:event.target,transition: "pop" } );
    		event.preventDefault();
		});
		//return html;
	}
	//获取某个
	function queryTaskEquipmentInfos(task_id){
		$.ajax({   
			url : $.ServerPath+"/task/mobile/queryTaskEquipmentInfos.do",  
			data:{task_id:task_id},  
			success : function(data){
				if(data.success==true){	
					var root=data.root;
					renderEquipmentInfo(root,true);
				}
				$.hideLoader();  
			},
			error:function(jqxhq){  
				//$("#errorMsg").html('网络异常或服务停止了'); 
				alert("网络异常或服务停止了"); 
				$.hideLoader(); 
			}  
		});
	}
	//扫描的时候获取设备相关信息
	function getEquipmentInfo(ecode){
		$.ajax({   
			url : $.ServerPath+"/task/mobile/getEquipmentInfo.do",  
			data:{ecode:ecode},  
			success : function(data){
				if(data.success==true){	
					var root=data.root;
					if(root.status!=2 && taskInfoParam.type=='newInstall'){
						alert("设备没有不是'安装出库'状态，不能进行安装!");
						return;
					} else if((root.status!=2 && root.status!=3) && taskInfoParam.type=='repair'){
						alert("设备没有不是'安装出库','使用中'状态，不能进行扫描!");
						return;
					} else if(root.status!=3 && taskInfoParam.type=='patrol'){
						alert("设备没有不是'使用中'状态，不能进行扫描!");
						return;
					}
					renderEquipmentInfo(root);
					
				}
				$.hideLoader();  
			},
			error:function(jqxhq){  
				//$("#errorMsg").html('网络异常或服务停止了'); 
				alert("没有这个设备!"); 
				$.hideLoader(); 
			}  
		});
	}

	function deleteEquipmentInfo(){
		//选择了设备
		
		$(window.equipmentInfoCollapsible).remove();
		//alert(window.equipmentInfoCollapsible);
		var page_id=taskInfoParam.page_id;
		$( "#"+page_id+"_deleteEquipmentInfo_popup" ).popup( "close");
		//alert(2);
		window.equipmentInfoCollapsible=null;
	}

	$("input[name='scan_textfield']").keyup(function(event){
	  	if(event.target.value.length==$.ecodeLength){
			getEquipmentInfo(event.target.value);
			event.target.value="";
		}	
	});
	$("a[name='scan_button']").click(function(event){
	  	cordova.plugins.barcodeScanner.scan(
			function (result) {
		    	//alert("We got a barcode\n" +
  		          //     "Result: " + result.text + "\n" +
  		          //      "Format: " + result.format + "\n" +
  		          //      "Cancelled: " + result.cancelled);
				if(!result.cancelled){
					//同时去后台获取设备信息
					getEquipmentInfo(result.text);
				}
		    }, 
		    function (error) {
		     	alert("扫描失败: " + error);
		    }
		); 
	});
	$("a[name='deleteEquipmentInfo']").click(function(event){
	  	deleteEquipmentInfo();
	});
	$("button[name='saveTask']").click(function(event){
	  	saveTask();
	});
	$("button[name='submitTask']").click(function(event){
	  	submitTask();
	});
	
});

</script>

</body>
</html>
