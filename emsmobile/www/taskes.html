<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<title>任务列表</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="cordova.js"></script>
<link href="jquery.mobile/jquery.mobile-1.4.4.min.css" rel="stylesheet" type="text/css"/>
<script src="jquery.mobile/jquery-2.1.1.min.js" type="text/javascript"></script>
<script src="jquery.mobile/jquery.mobile-1.4.4.min.js" type="text/javascript"></script>
<script src="js/main.js" type="text/javascript"></script>
<style type="text/css">
.secondNavbar-glyphish-example .ui-btn { padding-top: 40px !important; }
.secondNavbar-glyphish-example .ui-btn:after { width: 34px!important; height: 34px!important; margin-left: -15px !important; box-shadow: none!important; -moz-box-shadow: none!important; -webkit-box-shadow: none!important; -webkit-border-radius: 0 !important; border-radius: 0 !important; }
.ui-icon-install:after {
    background-image: url("img/install.png");
    /* Make your icon fit */
    background-size: 34px 34px;
	background-color:#f6f6f6;
}
.ui-icon-repair:after {
    background-image: url("img/repair.png");
    /* Make your icon fit */
    background-size: 34px 34px;
	background-color:#f6f6f6;
}
.ui-icon-patrols:after {
    background-image: url("img/patrols.png");
    /* Make your icon fit */
    background-size: 34px 34px;
	background-color:#f6f6f6;
}
.ui-icon-cancel:after {
    background-image: url("img/cancel.png");
    /* Make your icon fit */
    background-size: 34px 34px;
	background-color:#f6f6f6;
}
.ui-icon-taskes-refresh:after {
    background-image: url("img/refresh.png");
    /* Make your icon fit */
    background-size: 34px 34px;
	background-color:#f6f6f6;
}



#fullbg {
    background-color:Gray;
    left:0px;
    opacity:0.5;
    position:absolute;
    top:0px;
    z-index:100;
    filter:alpha(opacity=50); /* IE6 */
    -moz-opacity:0.5; /* Mozilla */
    -khtml-opacity:0.5; /* Safari */
}

.taskes_list_display_none{
	display:none;
}
.taskes_list_display_block{
	display:block;
}

.longContent{
	white-space:normal !important;
}

</style>
<script type="application/javascript">
$(function(){
	$( ":mobile-pagecontainer" ).pagecontainer( "load", "taskes_new.html", {  } );	
})
var secondNavbarIsHide=true;
//切换二级菜单，type就是新建任务的类型,也可以为null
//callback:当菜单切换完后执行的函数
function toggleSecondNavbar(type,callback){	
	$("#secondNavbar").toggle(500,function(){
		secondNavbarIsHide=!secondNavbarIsHide;
		if(callback){
			callback();
		}
	});
	if(secondNavbarIsHide){
		var footernavZIndex=$("#footernav").css("z-index");
		$("#footernav").css("z-index","50");
		//$("#footernav").css("z-index","50");
		showBg();	
		$("#dialog").show();//显示二级菜单
	} else {
		$("#footernav").css("z-index",footernavZIndex);
		closeBg();
	}
	if(type){
		//表示要进行跳转了
		//$( ":mobile-pagecontainer" ).pagecontainer( "load", "taskes_new.html", {  } );
		window.page_taskes_new_type=type;
		var params={
			type:type
		};
		window.page_taskes_new_params=params;
	}
	
	
}

//显示灰色 jQuery 遮罩层
function showBg(fullScreen) {
    var bh = $("body").height();
    var bw = $("body").width();
    $("#fullbg").css({
        height:bh,
        width:bw,
		top:fullScreen?$("#page_homepage_header").height():0,
		//zIndex:2500,
        display:"block"
    });
    
}
//关闭灰色 jQuery 遮罩
function closeBg() {
    $("#fullbg").hide();
}


window["working_pageParam"]=new Page(0,20);
window["confirm_pageParam"]=new Page(0,20);
window["complete_pageParam"]=new Page(0,20);
//查询任务
//status:working,confirm,complete
//appendDir:append表示是要加在现有数据后面的，prepend在开头插入数据，用在定时刷新上,其他的值，全部刷新
function queryTasks(status,appendDir,callBack){
	pageParam =window[status+"_pageParam"];
	$.ajax({   
		url : $.ServerPath+"/task/mobile/query.do",  
		data:{start:pageParam.start,limit:pageParam.limit,status:status},  
		success : function(data){
			if(data.success==true){
				var root=data.root;
				var html="";
				for(var i=0;i<root.length;i++){
					var taskInfoParamStr='?id='+root[i].id+'&pole_name='+root[i].pole_name+'&memo='+root[i].memo+'&type='+root[i].type+'&canEdit='+(status=="working"?true:false);
					//alert(taskInfoParamStr);
					var page_id="";
					var h2_title="";
					var img="";
					if("newInstall"==root[i].type){
						page_id="page_install";
						h2_title="新安装";
						img="img/install.png";
					} else if("repair"==root[i].type){
						page_id="page_repair";
						h2_title="维修";
						img="img/repair.png";
					} else if("patrol"==root[i].type){
						page_id="page_patrol";
						h2_title="巡检";
						img="img/patrols.png";
					}else if("cancel"==root[i].type){
						page_id="page_cancel";
						h2_title="取消点位";
						img="img/cancel.png";
					}
					html+='<li id="li_'+root[i].id+'">'+
					'<a href="#'+page_id+'" onclick="sessionStorage.taskInfoParamStr=\''+taskInfoParamStr+'\'" data-transition="slide" >'+
						'<img src="'+img+'">'+
						'<h2>'+root[i].id+'</h2>'+
						'<p>'+h2_title+':'+root[i].pole_name+'</p>'+
						'<p class="longContent">地址:'+root[i].pole_address+'</p>'+
						'<p class="ui-li-aside"><strong>'+root[i].createDate+'</strong></p>'+
						((root[i].status!="newTask")?'':'<p id="'+root[i].id+'_isNew" class="ui-li-count" style="color:#FFF;background-color:#F00;">new</p>')+
					'</a>'+
					'</li>'
				}
				if(appendDir=="append"){
					$("#taskes_list_"+status).append(html).listview('refresh');
				} else if(appendDir=="prepend"){
					$("#taskes_list_"+status).prepend(html).listview('refresh');
				} else {
					$("#taskes_list_"+status).html(html).listview('refresh');
				}
				//下次开始获取的数据
				//pageParam.start=pageParam.start+root.length;
				pageParam.addStart(root.length);
				
			}else{
				//$("#errorMsg").html(data.reasons.reason);
			}
			 
			if(callBack){
				callBack();
			}
			},
			error:function(jqxhq){  
				$("#errorMsg").html('网络异常或服务停止了');  
				if(callBack){
					callBack();
				}
			}  
	});
}
//切换任务状态框
var taskes_list_query_status={
	working:false,
	'confirm':false,
	complete:false
};
function changeTaskesStatus(status){
	$("ul[id^='taskes_list_']").removeClass("taskes_list_display_block").addClass("taskes_list_display_none");
	$("#taskes_list_"+status).addClass("taskes_list_display_block");
	//如果数据已经查询过了，就不再查询了
	if(!taskes_list_query_status[status]){
		$.showLoader("正在加载....");
		queryTasks(status,null,function(){
			$.hideLoader();
			window.isLazyLoading=false;
		});
		taskes_list_query_status[status]=true;
	}
	
}
//点击刷新按钮，刷新任务
function refreshTaskes(){
	toggleSecondNavbar(null,function(){
		var status=$("input:checked[name='radio-choice-taskes-status']").val();
		window[status+"_pageParam"].reset();
		queryTasks(status,null,function(){
				window.isLazyLoading=false;
				$.hideLoader(); 
		});
	});
	
}
$(document).ready(function(e) {
	//---初始化任务信息
	var status=$("input:checked[name='radio-choice-taskes-status']").val();
	changeTaskesStatus(status);
	$("input[name=radio-choice-taskes-status]").click(function(e){
	    //var val=$("input:checked[name='radio-choice-taskes-status']").val();
	    //当选择条件发生变化的时候
		
	    status=$(e.target).val();
		changeTaskesStatus(status);
	});
	//到底部的时候去加在最新的数据
	window.isLazyLoading=true;//防止二次刷新,设置为true是防止只有一个页面数据的时候，两次查询
	$(window).scroll(function(){
	if(!window.isLazyLoading&&($(window).scrollTop()==$(document).height()-$(window).height())){
		window.isLazyLoading=true;
//		$("#taskes_list_"+status).append( "<li ><div class='ui-loader'><span class='ui-icon ui-icon-loading'></span></div></li>" ).listview( "refresh" );
		queryTasks(status,"append",function(){
			window.isLazyLoading=false;
			$.hideLoader(); 
		});
	}
	});
	//定时刷新任务,定时更新数据
	setInterval(function(){
		//$.showLoader("正在加载....");
		queryTasks("working","prepend",function(){
			//$.hideLoader();
		});
	 }, "120000");
	
	//初始化滑出菜单
	htmlobj=$.ajax({url:"leftMenu.html",async:false});
  	$("#left-menu-contanier").html(htmlobj.responseText).trigger('create');

});
</script>


</head> 
<body> 

<div data-role="page" id="page_homepage">
	<div id="page_homepage_header" data-role="header" data-position="fixed"  >
        <a href="#left-menu" data-icon="gear" data-iconpos="notext"></a> 
        <div id="left-menu-contanier"></div>
        <div  data-role="controlgroup" data-type="horizontal" align="center" >
            <input type="radio" name="radio-choice-taskes-status" id="radio-choice-taskes-statusa" value="working" checked="checked">
            <label for="radio-choice-taskes-statusa">当前</label>
            <input type="radio" name="radio-choice-taskes-status" id="radio-choice-taskes-statusb" value="confirm">
            <label for="radio-choice-taskes-statusb">确认中</label>
            <input type="radio" name="radio-choice-taskes-status" id="radio-choice-taskes-statusc" value="complete">
            <label for="radio-choice-taskes-statusc">已完成</label>
        </div>
        <!--<a href="#" data-icon="plus" data-iconpos="notext" data-ajax="false"></a>-->
        <button href="#" data-icon="plus" data-iconpos="notext" onClick="toggleSecondNavbar();"></button>
		<div data-role="navbar" id="secondNavbar" class="secondNavbar-glyphish-example" style="display:none;">
        	<ul>
            	<li><a href="#page_taskes_new" onClick="toggleSecondNavbar('newInstall');"  class="ui-icon-install ui-btn-icon-top">新安装</a></li>
                <li><a href="#page_taskes_new" onClick="toggleSecondNavbar('repair');" class="ui-icon-repair ui-btn-icon-top">维修</a></li>
                <li><a href="#page_taskes_new" onClick="toggleSecondNavbar('patrol');" class="ui-icon-patrols ui-btn-icon-top">巡检</a></li>
                <li><a href="#page_taskes_refresh" onClick="refreshTaskes();" class="ui-icon-taskes-refresh ui-btn-icon-top">刷新</a></li>
            </ul>
        </div>
    </div>
	<div role="main" class="ui-content" id="page_content">
		<ul data-role="listview" id="taskes_list_working">
        </ul> 
        
        <ul data-role="listview" id="taskes_list_confirm" > 
        </ul> 
        <ul data-role="listview" id="taskes_list_complete"> 
        </ul>
	</div>
    <!-- jQuery 遮罩层 -->
	<div id="fullbg"  onClick="toggleSecondNavbar();"></div>
    
    
	<div data-role="footer" id="footernav"  data-id="footernav" data-position="fixed" data-tap-toggle="false">
		<div data-role="navbar">  
            <ul>  
                <li><a href="messages.html"  data-icon="mail" data-ajax="false" data-transition="fade">消息提醒</a></li>  
                <li><a href="taskes.html" data-icon="bullets" data-ajax="false" data-transition="fade" class="ui-btn-active ui-state-persist" >任务列表</a></li>  
                <li><a href="others.html" data-icon="star" data-ajax="false" data-transition="fade">其他</a></li>  
            </ul>  
        </div>  
	</div>
</div>


<div data-role="page" id="page_install">
	<div data-role="header" data-position="fixed">
    	<a href="#page_homepage" class="ui-btn ui-corner-all" data-rel="back" data-theme="c">返回</a>
        <h1>设备新安装</h1> 
	</div>
	<div role="main" class="ui-content">
        <div class="ui-field-contain">
            <label for="id">任务编号:</label>
            <input type="text"  id="page_install_id" placeholder="只读" value="">
            <label for="pole">点位:</label>
            <input readonly type="text" id="page_install_pole_name" placeholder="只读" value="">
        	<label  for="memo">任务描述:</label>
    		<textarea readonly id="page_install_memo" placeholder="只读" data-mini="true"></textarea>
         </div>	
         <a href="#" class="ui-btn ui-corner-all actionbutton"  id="page_install_scan_button" name="scan_button">扫描新设备</a>
         <input type="text" id="page_install_scan_textfield" class="actionbutton" name="scan_textfield"  value="" placeholder="请扫描或手动输入...">
         <div id="page_install_equipments_list">
         	
          </div>
          <!--
            <textarea cols="40" rows="8" name="textarea" id="textarea" placeholder="请填写设备安装描述"></textarea>
         -->
         <div class="ui-field-contain actionbutton"  align="center">
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="saveTask">保存</button>
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="submitTask">提交</button>
         </div>
	</div>
    <script type="text/javascript">

	</script>
    <div data-role="popup" id="page_install_deleteEquipmentInfo_popup" data-arrow="b" data-theme="b">
        <a href="javascript:void(0);" data-role="button" name="deleteEquipmentInfo">删除</a>
    </div>
</div>

<div data-role="page" id="page_repair">
	<div data-role="header" data-position="fixed">
    	<a href="#page_homepage" class="ui-btn ui-corner-all" data-rel="back" data-theme="c">返回</a>
        <h1>设备维修</h1> 
	</div>
	<div role="main" class="ui-content">
        <div class="ui-field-contain">
            <label for="id">任务编号:</label>
            <input type="text"  id="page_repair_id" placeholder="只读" value="">
            <label for="pole">点位:</label>
            <input readonly type="text" id="page_repair_pole_name" placeholder="只读" value="">
        	<label  for="memo">任务描述:</label>
    		<textarea readonly  id="page_repair_memo" placeholder="只读" data-mini="true"></textarea>
         </div>	
         <select name="select-choice-a" id="select-choice-hitchType" data-native-menu="false">
        	<option>请选择故障类型</option>
        </select>

        <select name="select-choice-a" id="select-choice-hitchReasonTpl" data-native-menu="false">
        	<option>请选择原因模板</option>
        </select>
        <textarea  name="textarea" id="textarea-hitchReasonTpl" placeholder="请填写设备故障原因情况"></textarea>
         <a href="#" class="ui-btn ui-corner-all actionbutton" name="scan_button">扫描设备</a>
         <input type="text" name="scan_textfield" class="actionbutton"  value="" placeholder="请扫描或手动输入...">
         <div id="page_repair_equipments_list">
         	
          </div>
         <div class="ui-field-contain actionbutton"  align="center">
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="saveTask">保存</button>
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="submitTask">提交</button>
         </div>
	</div>
    <script type="text/javascript">
		
		$(function(){
			//初始化故障类型和原因模板
			var hitchTypes=$.tasks.getHitchType();
			hitchTypes=hitchTypes==null?[]:hitchTypes;
			var html="";
			for(var i=0;i<hitchTypes.length;i++){
				html+='<option value="'+hitchTypes[i].id+'">'+hitchTypes[i].name+'</option>';
			}
			$("#select-choice-hitchType").append(html).trigger("create");;
			var hitchReasonTples=$.tasks.getHitchReasonTpl();
			hitchReasonTples=hitchReasonTples==null?[]:hitchReasonTples;
			html="";
			for(var i=0;i<hitchReasonTples.length;i++){
				html+='<option value="'+hitchReasonTples[i].id+'">'+hitchReasonTples[i].name+'</option>';
			}
			$("#select-choice-hitchReasonTpl").append(html).trigger("create");
			
			$("#select-choice-hitchReasonTpl").change(function(e){
				for(var i=0;i<hitchReasonTples.length;i++){
					if(hitchReasonTples[i].id==$(e.target).val()){
						$("#textarea-hitchReasonTpl").val(hitchReasonTples[i].tpl);
					}
				}
				
			});
		});
	</script>
    <div data-role="popup" id="page_repair_deleteEquipmentInfo_popup" data-arrow="b" data-theme="b">
        <a href="javascript:void(0);" data-role="button" name="deleteEquipmentInfo">删除</a>
        <a href="javascript:void(0);" data-role="button" name="out_storageEquipmentInfo">未损坏</a>
        <!-- <a href="javascript:void(0);" data-role="button" name="breakdownEquipmentInfo">已损坏</a>-->
    </div>
</div>

<div data-role="page" id="page_patrol">

	<div data-role="header" data-position="fixed">
    	<a href="#page_homepage" class="ui-btn ui-corner-all" data-rel="back" data-theme="c">返回</a>
        <h1>巡检</h1> 
	</div>
	<div role="main" class="ui-content">
        <div class="ui-field-contain">
            <label for="id">任务编号:</label>
            <input type="text"  id="page_patrol_id" placeholder="只读" value="">
            <label for="pole">点位:</label>
            <input readonly type="text" id="page_patrol_pole_name" placeholder="只读" value="">
        	<label  for="memo">任务描述:</label>
    		<textarea readonly  id="page_patrol_memo" placeholder="只读" data-mini="true"></textarea>
         </div>	
         <a href="#" class="ui-btn ui-corner-all actionbutton" name="scan_button">扫描设备</a>
         <input type="text" name="scan_textfield" class="actionbutton"  value="" placeholder="请扫描或手动输入...">
         <div id="page_patrol_equipments_list">
         	
         </div>
         <div class="ui-field-contain actionbutton"  align="center">
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="saveTask">保存</button>
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="submitTask">提交</button>
         </div>
	</div>
    <script type="text/javascript">

	</script>
    <div data-role="popup" id="page_patrol_deleteEquipmentInfo_popup" data-arrow="b" data-theme="b">
        <a href="javascript:void(0);" data-role="button" name="deleteEquipmentInfo">删除</a>
    </div>
</div>

<div data-role="page" id="page_cancel">

	<div data-role="header" data-position="fixed">
    	<a href="#page_homepage" class="ui-btn ui-corner-all" data-rel="back" data-theme="c">返回</a>
        <h1>取消点位</h1> 
	</div>
	<div role="main" class="ui-content">
        <div class="ui-field-contain">
            <label for="id">任务编号:</label>
            <input type="text"  id="page_cancel_id" placeholder="只读" value="">
            <label for="pole">点位:</label>
            <input readonly type="text" id="page_cancel_pole_name" placeholder="只读" value="">
        	<label  for="memo">任务描述:</label>
    		<textarea readonly  id="page_cancel_memo" placeholder="只读" data-mini="true"></textarea>
         </div>	
         <a href="#" class="ui-btn ui-corner-all actionbutton" name="scan_button">扫描设备</a>
         <input type="text" name="scan_textfield" class="actionbutton"  value="" placeholder="请扫描或手动输入...">
         <div id="page_cancel_equipments_list">
         	
         </div>
         <div class="ui-field-contain actionbutton"  align="center">
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="saveTask">保存</button>
            <button class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-btn-icon-left" name="submitTask">提交</button>
         </div>
	</div>
    <script type="text/javascript">

	</script>
    <div data-role="popup" id="page_cancel_deleteEquipmentInfo_popup" data-arrow="b" data-theme="b">
        <a href="javascript:void(0);" data-role="button" name="deleteEquipmentInfo">删除</a>
    </div>
</div>

<script type="application/javascript">
$(document).ready(function(e) {
	
	$( document).on( "pagecontainershow", function( event, ui ) {
		var page_id=ui.toPage.attr("id");
		//if (sessionStorage.taskInfoParamStr!='null') {
		if (page_id=="page_install" || page_id=="page_repair" || page_id=="page_patrol" || page_id=="page_cancel") {
			//从url中解析参数  
			var params = $.getUrlParam(sessionStorage.taskInfoParamStr);  
			window.taskInfoParam=params;
			taskInfoParam.page_id=page_id; 
			//alert(params.canEdit);
			if(params.canEdit=="true"){//隐藏按钮
				$(".actionbutton").show();
			} else {
				$(".actionbutton").hide();
			}
			$("#"+page_id+"_id").val(params.id);  
			$("#"+page_id+"_pole_name").val(params.pole_name);  
			$("#"+page_id+"_memo").val(params.memo);
			sessionStorage.taskInfoParamStr=null;
			//初始化设备列表信息
			queryTaskEquipmentInfos(params.id);
			$("#"+taskInfoParam.id+"_isNew").remove();
			
		}  	
	});
	//isSubmit：true表示是提交的时候获取参数
	function getSubmitParams(isSubmit){
		//var params="&task_id="+$("#page_install_id").val();
		var params="&task_id="+taskInfoParam.id+"&task_type="+taskInfoParam.type;
		var page_id=taskInfoParam.page_id;
		var scaned=false;
		$("#"+page_id+"_equipments_list [data-role='collapsible']").each(function(index, element) {
            //values.push($(this).attr("ecode"));
			params+="&ecodes="+$(this).attr("ecode");
			params+="&equipment_statuses="+$(this).attr("equipment_status");
			scaned=true;
        });
		if(isSubmit&&!scaned){
			alert("请先扫描设备!");
			return false;
		}
		
		if(taskInfoParam.type=='repair'){
			var hitchType_id=$("#select-choice-hitchType").val();
			if(!hitchType_id){
				alert("请先选故障类型");
				return false;
			}
			var hitchReasonTpl_id=$("#select-choice-hitchReasonTpl").val();
			if(!hitchReasonTpl_id){
				alert("请先选故障原因模板!");
				return false;
			}
			params+="&hitchType_id="+hitchType_id;
			params+="&hitchReasonTpl_id="+hitchReasonTpl_id;
			
			params+="&hitchReason="+$("#textarea-hitchReasonTpl").val();
		}
		return params;
	}
	function saveTask(){
		$.showLoader("正在保存....");
		var params=getSubmitParams();
		if(params==false){
			$.hideLoader();  
			return;
		}
		/****/
		$.ajax({   
			url : $.ServerPath+"/task/mobile/save.do",  
			data:params,  
			success : function(data){
				if(data.success==true){	
					
				}
				$.hideLoader();  
			}
		});	
	}
	function submitTask(){
		$.showLoader("正在提交....");

		var params=getSubmitParams(true);
		if(params==false){
			$.hideLoader();  
			return;
		}
		/****/
		$.ajax({   
			url : $.ServerPath+"/task/mobile/submit.do",  
			data:params,  
			success : function(data){
				if(data.success==true){	
					//var previous = $(':mobile-pagecontainer').pagecontainer( "getActivePage" ).prev('[data-role=page]');
					$.mobile.changePage("#page_homepage", { 
						  transition: 'slide',
						  reverse: true });
					//并且刷新任务,或者移除该任务
					//changeTaskesStatus("working");
					$('#li_'+taskInfoParam.id).remove();
					//刷新待确认的任务
					window["confirm_pageParam"].reset();
					queryTasks("confirm",null,function(){
						//切换confirm任务的状态,这样再点击的时候，就不会重新去查询了
						taskes_list_query_status["confirm"]=true;
					});
				}
				$.hideLoader();  
			}
		});	
	}

	//渲染设备列表
	function renderEquipmentInfo(obj,coverHtml){
		var html="";
		var root=obj.equipmentVOs;
		if(!(obj.equipmentVOs instanceof Array)){
			root=[obj];
		} 
		var color="";
		for(var i=0;i<root.length;i++){
			color="";
			if(root[i].equipment_status==4){
				color='color="#F00"';//如果是损坏设备就表示为红色
			}
			//如果设备状态是手持，就是安装，如果是using就是维修或者巡检，巡检任务扫描的设备都是巡检
			html+='<div data-role="collapsible" ecode="'+root[i].ecode+'" equipment_status="'+root[i].equipment_status+'">'+
				'<h4><font '+color+'>'+root[i].ecode+':'+root[i].style+'</font></h4>'+
				'<p>'+root[i].brand_name+':'+root[i].subtype_name+'>'+root[i].prod_name+'>'+root[i].supplier_name+'</p>'+
				'</div>';	
		}
		var page_id=taskInfoParam.page_id;
		if(coverHtml){
			//覆盖已经有的html
			$("#"+page_id+"_equipments_list").html(html).enhanceWithin();
		} else {
			$("#"+page_id+"_equipments_list").append(html).enhanceWithin();
		}
		
		$("#"+page_id+"_equipments_list [data-role='collapsible']").unbind("taphold"); 
		$("#"+page_id+"_equipments_list [data-role='collapsible']").bind( "taphold", function(event){
			//window.equipmentInfoCollapsible=event.target;
			//console.dir(event.target);
			//触发的是<a>,但删除的是div，所以要parent
			window.equipmentInfoCollapsible=$(event.target).parent().parent();
			
			//$( "#popupArrow" ).popup( "open", { positionTo:event.target,transition: "pop" } );
			$( "#"+page_id+"_deleteEquipmentInfo_popup" ).popup( "open", { positionTo:event.target,transition: "pop" } );
    		event.preventDefault();
		});
		
		//渲染损坏类型和损坏原因
		if(obj.type=="repair"){
			$("#select-choice-hitchType").val(obj.hitchType_id).selectmenu( "refresh" );
			$("#select-choice-hitchReasonTpl").val(obj.hitchReasonTpl_id).selectmenu( "refresh" );
			$("#textarea-hitchReasonTpl").val(obj.hitchReason);
		}
		
	}
	//获取某个任务所有相关设备信息
	function queryTaskEquipmentInfos(task_id){
		$.ajax({   
			url : $.ServerPath+"/task/mobile/queryTaskEquipmentInfos.do",  
			data:{task_id:task_id},  
			success : function(data){
				if(data.success==true){	
					var root=data.root;
					renderEquipmentInfo(root,true);
				}
				$.hideLoader();  
			}
		});
	}
	//扫描的时候获取设备相关信息
	function getEquipmentInfo(ecode){
		$.ajax({   
			url : $.ServerPath+"/task/mobile/getEquipmentInfo.do",  
			data:{ecode:ecode,task_id:taskInfoParam.id},  
			success : function(data){
				if(data.success==true){	
					var root=data.root;
	//				if(root.status!=2 && taskInfoParam.type=='newInstall'){
//						alert("设备没有不是'安装出库'状态，不能进行安装!");
//						return;
//					} else if((root.status!=2 && root.status!=3) && taskInfoParam.type=='repair'){
//						alert("设备没有不是'安装出库','使用中'状态，不能进行扫描!");
//						return;
//					} else if(root.status!=3 && taskInfoParam.type=='patrol'){
//						alert("设备没有不是'使用中'状态，不能进行扫描!");
//						return;
//					}
					renderEquipmentInfo(root);
					
				}
				$.hideLoader();  
			}
		});
	}

	function deleteEquipmentInfo(){
		//选择了设备
		
		$(window.equipmentInfoCollapsible).remove();
		window.equipmentInfoCollapsible=null;
		//alert(window.equipmentInfoCollapsible);
		var page_id=taskInfoParam.page_id;
		$( "#"+page_id+"_deleteEquipmentInfo_popup" ).popup( "close");
		//alert(2);
		
	}
	//把设备标识为“安装出库”状态
	function out_storageEquipmentInfo(){
		var li=$(window.equipmentInfoCollapsible);
		var equipment_status=li.attr("equipment_status");
		//alert(equipment_status);
		if(equipment_status==4){
			li.attr("equipment_status",2);
			//修改颜色为黑色
			//alert(li.find("font"));
			li.find("font").removeAttr("color");
			//$( "#"+page_id+"_equipments_list" ).trigger( "updatelayout" );
		}
		var page_id=taskInfoParam.page_id;
		$( "#"+page_id+"_deleteEquipmentInfo_popup" ).popup( "close");
	}
	//把设备标识为损坏
	function breakdownEquipmentInfo(){
		
	}

	$("input[name='scan_textfield']").keyup(function(event){
	  	if(event.target.value.length==$.ecodeLength){
			getEquipmentInfo(event.target.value);
			event.target.value="";
		}	
	});
	$("a[name='scan_button']").click(function(event){
	  	cordova.plugins.barcodeScanner.scan(
			function (result) {
		    	//alert("We got a barcode\n" +
  		          //     "Result: " + result.text + "\n" +
  		          //      "Format: " + result.format + "\n" +
  		          //      "Cancelled: " + result.cancelled);
				if(!result.cancelled){
					//同时去后台获取设备信息
					getEquipmentInfo(result.text);
				}
		    }, 
		    function (error) {
		     	alert("扫描失败: " + error);
		    }
		); 
	});
	$("a[name='out_storageEquipmentInfo']").click(function(event){
	  	out_storageEquipmentInfo();
	});
	$("a[name='deleteEquipmentInfo']").click(function(event){
	  	deleteEquipmentInfo();
	});
	$("button[name='saveTask']").click(function(event){
	  	saveTask();
	});
	$("button[name='submitTask']").click(function(event){
	  	submitTask();
	});
	
});


</script>


<!----------------------新建任务系列--------------------------->

</body>
</html>
