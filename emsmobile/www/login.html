<!DOCTYPE html> 
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>登录</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="cordova.js"></script>
<link href="jquery.mobile/jquery.mobile-1.4.4.min.css" rel="stylesheet" type="text/css"/>
<script src="jquery.mobile/jquery-2.1.1.min.js" type="text/javascript"></script>
<script src="jquery.mobile/jquery.mobile-1.4.4.min.js" type="text/javascript"></script>
<script src="jquery-validation/dist/jquery.validate.min.js" type="text/javascript"></script>
<script src="js/main.js" type="text/javascript"></script>
<style type="text/css">
label.error{
    color: red;
    font-size: 16px;
    font-weight: normal;
    line-height: 1.4;
    margin-top: 0.5em;
    width: 100%;
    float: none;
}
</style>

<script type="application/javascript">
	
</script>
</head> 
<body> 

<div data-role="page" id="page_homepage">
	<div data-role="header">
        <h1>生产调度系统</h1>
	</div>
	<div role="main" class="ui-content">
    <form id="formLogin" class="validate"> 
        <div style="padding:10px 20px;">
            <h3>请登录:</h3>
            <input type="text" name="loginName" id="loginName"  placeholder="用户名" data-theme="a" class="required">
            <input type="password" name="password" id="password"  placeholder="密码" data-theme="a" class="required">
            <input type="text" name="ServerIP" id="ServerIP"  placeholder="服务器地址" value="" data-theme="a" class="required">

          <select name="server_port" id="server_port" data-role="slider" >
            <option value="8081" selected="">测试库</option>
            <option value="8080" >正式库</option>
          </select>
            <div id="errorMsg" style="color:red;height:36px;font-weight:bold;">
            
            </div>
            <button type="submit" id="submit" data-theme="b" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ">登录</button>
        </div>
 	</form>
	</div>
    
	<footer data-role="footer" ><h1>@2014 宁波东望智能系统工程有限公司</h1>
    <div style="font-size:13px;text-align:center;">版本1.1.9</div>
    </footer>
</div>
<script type="text/javascript">
$(function() { 
	//初始化表单的ServerPath
	var ServerIP=localStorage.getItem("ServerIP");
	if(!ServerIP){
		ServerIP="122.227.163.82";
	}
	$("#ServerIP").val(ServerIP);
	
	
	
	
	//初始化用户名
	var loginName=localStorage.getItem("loginName");
	if(loginName){
		$("#loginName").val(loginName);
	}
	
	$("#formLogin").validate({ 
		submitHandler: function(form) { 
			//获取端口号
			var ServerPort=$("#server_port").val();
			$.ServerPort=ServerPort;
			//alert(server_port);
	
			//console.log("Call Login Action"); 
			var values=$(form).serializeJson();
			$.showLoader("正在登陆....");
			////获取损坏类型和损坏原因模板的版本。
			//values.HitchType_version=$.tasks.getHitchType_version();
			//values.HitchReasonTpl_version=$.tasks.getHitchReasonTpl_version();
			var ServerIP=$("#ServerIP").val();
			var ServerPath="http://"+ServerIP+":"+$.ServerPort;
			$.ajax({   
				url : ServerPath+"/mobile/login.do",  
				data:values,  
				success : function(data){  
					if(data.success==true){
						//保存新的IP地址
						localStorage.setItem("ServerIP",ServerIP);
						localStorage.setItem("ServerPort",ServerPort);
						$.ServerPath=ServerPath;
						
						//保存用户名
						localStorage.setItem("loginName",values.loginName);

						sessionStorage.setItem("user",JSON.stringify(data.root));
						//localStorage.setItem("gps_interval",data.gps_interval);
						//$.mobile.pageContainer.pagecontainer('change', "messages.html", {
						//	transition: 'slide',
						//	reload    : true
						//});
						//更新损坏类型，和损坏原因的数据
						$.showLoader("更新字典数据....");
						var user=data.root;
						if(user.metaVersion==null){
							user.metaVersion={};
						}
						$.tasks.updateAll($.tasks.getHitchType_version(),function(){
							location.href="taskes.html";
						});
						
					}else{
						$("#errorMsg").html(data.reasons.reason);
						//if(data.reasons.code=="noLogin"){
						////	location.href="login.html";
						//	return;
						//}
					}
					$.hideLoader();  
				},
				error: function(){
					$("#errorMsg").html("网络生异常或服务器没有启动!");
					$.hideLoader();  
				}
			});   
		} 
	}); 
	/**
    $('#submit').bind('click', function() { 
	//alert(1);
		//$.mobile.changePage('index.html');
		location.href="messages.html";
	});
	**/
});
</script>

</body>
</html>
