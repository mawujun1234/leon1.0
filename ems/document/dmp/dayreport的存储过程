create or replace procedure proc_dayreport(day_in in varchar2)
as
lastmonth_in varchar2(6):=to_char(add_months(to_date(day_in,'yyyymmdd'),-1),'yyyymm');
--lastday_in varchar2(8):=TRUNC(to_date(day_in,'yyyymmdd'))-1;
begin
 
-------------------------------------------------------------------------------------------------- 
---计算备品备件库的报表 
  for store in (
    select * from ems_store where type=3 or type=1
  ) loop
     --清除要插入的月份的数据
  delete report_dayreport where daykey=day_in and store_id=store.id;
  
  --从日结表中获取数据
  for rec in (
    select distinct a.*,b.name as subtype_name,c.name as prod_name,c.unit,d.name as brand_name  
    from ems_dayinventory a
    inner join ems_equipmentsubtype b on a.subtype_id=b.id
    inner join ems_equipmentprod c on a.prod_id=c.id
    inner join ems_brand d on a.brand_id=d.id
    where a.store_id=store.id and a.daykey=day_in
  ) loop
    insert into report_dayreport(daykey,subtype_id,subtype_name,prod_id,prod_name,brand_id,brand_name,style,store_id,store_name,store_type,unit,memo
    ,lastnum,purchasenum,oldnum,installoutnum,repairinnum,scrapoutnum,repairoutnum,adjustoutnum,adjustinnum,nownum,nownum_query,supplementnum)
    values(day_in,rec.subtype_id,rec.subtype_name,rec.prod_id,rec.prod_name,rec.brand_id,rec.brand_name,rec.style,rec.store_id,store.name,rec.store_type,rec.unit,rec.memo
    ,rec.lastnum,rec.purchasenum,rec.oldnum,rec.installoutnum,rec.repairinnum,rec.scrapoutnum,rec.repairoutnum,rec.adjustoutnum,rec.adjustinnum,rec.nownum,rec.nownum_query,rec.supplementnum);
  end loop;


  --上月结余数
  for rec in(select * from ems_monthinventory where monthkey=lastmonth_in)
  loop
    update report_dayreport a set a.lastmonthnum=rec.nownum
    where a.subtype_id=rec.subtype_id and a.prod_id=rec.prod_id and a.brand_id=rec.brand_id and a.store_id=rec.store_id and a.style=rec.style and daykey=day_in;
  end loop;
  
  end loop;--for store in (
  commit;
end;
/

--------------========================================================月报的话，只需要读取月结报表中的数据就可以了
create or replace procedure proc_monthreport(month_in in varchar2)
as
--lastmonth_in varchar2(6):=to_char(add_months(to_date(month_in,'yyyymm'),-1),'yyyymm');
--lastday_in varchar2(8):=TRUNC(to_date(month_in,'yyyymmdd'))-1;
begin
 
-------------------------------------------------------------------------------------------------- 
---计算备品备件库的报表 
  for store in (
    select * from ems_store where type=3 or type=1
  ) loop
     --清除要插入的月份的数据
  delete report_monthreport where monthkey=month_in and store_id=store.id;
  
  --从日结表中获取数据
  for rec in (
    select distinct a.*,b.name as subtype_name,c.name as prod_name,c.unit,d.name as brand_name  
    from ems_monthinventory a
    inner join ems_equipmentsubtype b on a.subtype_id=b.id
    inner join ems_equipmentprod c on a.prod_id=c.id
    inner join ems_brand d on a.brand_id=d.id
    where a.store_id=store.id and a.monthkey=month_in
  ) loop
    insert into report_monthreport(monthkey,subtype_id,subtype_name,prod_id,prod_name,brand_id,brand_name,style,store_id,store_name,store_type,unit,memo
    ,fixednum,lastnum,purchasenum,oldnum,installoutnum,repairinnum,scrapoutnum,repairoutnum,adjustoutnum,adjustinnum,nownum,nownum_query,supplementnum)
    values(month_in,rec.subtype_id,rec.subtype_name,rec.prod_id,rec.prod_name,rec.brand_id,rec.brand_name,rec.style,rec.store_id,store.name,rec.store_type,rec.unit,rec.memo
    ,rec.fixednum,rec.lastnum,rec.purchasenum,rec.oldnum,rec.installoutnum,rec.repairinnum,rec.scrapoutnum,rec.repairoutnum,rec.adjustoutnum,rec.adjustinnum,rec.nownum,rec.nownum_query,rec.supplementnum);
  end loop;
  
  end loop;--for store in (
  commit;
end;
/