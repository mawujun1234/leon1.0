<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!-- mawujun qq:16064988 e-mail:16064988@qq.com-->
<mapper namespace="com.mawujun.store.OrderRepository">

	<select id="queryMain" resultType="com.mawujun.store.OrderVO" parameterType="map">
    	select a.* from ems_Order a
    	<where>
    		and a.store_id in (select store_id from sys_userstore c where c.user_id=#{user_id} and c.look='Y')
    		<if test="store_id!=null">
    			and a.store_id=#{store_id}
    		</if>
    		<if test="date_start!=null">
    			and a.orderDate &gt;=#{date_start}
    		</if>
    		<if test="date_end!=null">
    			and a.orderDate &lt;=#{date_end}
    		</if>
    		<if test="orderNo!=null">
    			and a.orderNo like #{orderNo}
    		</if>
    	</where>
    </select>
    
	<select id="queryUncompleteOrderno" resultType="string" parameterType="String">
    	SELECT distinct a.orderNo
	    FROM ems_order a,sys_userstore b
		where a.store_id=b.store_id and b.user_id=#{user_id} and b.edit='Y' and a.ordernum!=a.totalnum
    </select>
    
    <select id="query" resultType="com.mawujun.store.OrderVO" parameterType="String">
    	SELECT a.*,b.name as subtype_name,c.name as prod_name,d.name as brand_name,e.name as supplier_name
	    FROM ems_order a
	    inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		where a.orderNo=#{orderNo}   
    </select>
    
    <!--a0.status作为Equipment的状态 -->
    <select id="getEquipFromBarcode" resultType="com.mawujun.baseinfo.EquipmentVO" parameterType="String">
    	select a0.ecode,a0.order_id,a0.status,
		a.brand_id,
		a.prod_id,
		a.style,
		a.subtype_id,
		a.supplier_id,
		a.type_id,
		a.unitprice
		,b.name as subtype_name,c.name as prod_name,d.name as brand_name,e.name as supplier_name
		from ems_barcode a0 inner join ems_order a on a0.order_id=a.id 
		inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		where a0.ecode=#{ecode}  
    </select>

	
	<select id="updateTotalNum">
    	update ems_order 
    	set totalNum=${totalNum}
    	where id=#{order_id}
    </select> 
    
    
	<!-- 打印条码的时候，获取要打印的范围 
	select a.style,b.ecode from ems_Order a,ems_Barcode b 
    	where a.id=b.order_id and a.id=#{order_id} and b.seqnum &gt; #{startNum} and b.seqnum &lt;= #{endNum}
	-->    
    <select id="getBarcodesRange" resultType="com.mawujun.store.BarcodeVO" parameterType="map">
    	
    	
    	SELECT a.*,b.name as subtype_name,c.name as prod_name,d.name as brand_name,e.name as supplier_name,f.ecode
	    FROM ems_order a
	    inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		inner join ems_Barcode f on a.id=f.order_id and f.seqnum &gt; #{startNum} and f.seqnum &lt;= #{endNum}
		where a.id=#{order_id}   
    </select>
</mapper>

