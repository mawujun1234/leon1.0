<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!-- mawujun qq:16064988 e-mail:16064988@qq.com-->
<mapper namespace="com.mawujun.store.OrderRepository">

	<select id="queryMain" resultType="com.mawujun.store.OrderVO" parameterType="map">
    	select a.*,b.name as project_name,c.name as operater_name from 
    	(
    		select a.* from ems_Order a,ems_orderlist b
    		where a.id=b.order_id
    		<if test="project_id!=null and project_id!=''">
	    		and a.project_id = #{project_id}
	    	</if>
	    	<if test="supplier_id!=null and supplier_id!=''">
	    		and b.supplier_id = #{supplier_id}
	    	</if>
    	) a left join ems_project b on a.project_id=b.id
    	left join sys_user c on a.operater=c.id
    	<where>
    		and a.store_id in (select store_id from sys_userstore c where c.user_id=#{user_id} and c.look='Y')
    		<if test="store_id!=null and store_id!=''">
    			and a.store_id=#{store_id}
    		</if>
    		<if test="date_start!=null">
    			and a.orderDate &gt;=#{date_start}
    		</if>
    		<if test="date_end!=null">
    			and a.orderDate &lt;=#{date_end}
    		</if>
    		<if test="orderNo!=null and orderNo!=''">
    			and a.orderNo like #{orderNo}
    		</if>
    	</where>
    	order by a.orderDate desc
    </select>
    <select id="queryList" resultType="com.mawujun.store.OrderListVO" parameterType="map">
    	SELECT a.*,b.name as subtype_name,c.name as prod_name,c.spec as prod_spec,c.memo as prod_memo,c.unit as prod_unit,d.name as brand_name,e.name as supplier_name
	    FROM ems_orderlist a
	    inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		where a.order_id=#{order_id}   
    </select>
    <select id="queryList_count" resultType="int" parameterType="map">
    	select count(a.id) from ems_Orderlist a
    	where a.order_id=#{order_id}
    </select>
    
    <!-- 条码打印的时候，查询订单明细的数据-->
    <select id="queryList4Barcode" resultType="com.mawujun.store.OrderListVO" parameterType="map">
    	SELECT a.*,b.name as subtype_name,c.name as prod_name,c.spec as prod_spec,c.memo as prod_memo,c.unit as prod_unit,d.name as brand_name,e.name as supplier_name
	    FROM ems_orderlist a
	    inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		where a.order_id=#{order_id}   
    </select>
    
    <!-- 在条码导出的时候，查询还没有完成的订单 -->
    <select id="queryUncompleteOrderno" resultType="com.mawujun.store.Order" >
    	SELECT distinct a.id,a.orderNo
	    FROM ems_order a,sys_userstore b
		where a.store_id=b.store_id and b.user_id=#{user_id} and b.edit='Y' 
		and a.status='editover'
		<if test="orderNo!=null and orderNo!=''">
			and	a.orderNo like #{orderNo}
		</if>
		
		
    </select>
	<!-- <select id="queryUncompleteOrderno" resultType="string" parameterType="String">
    	SELECT distinct a.orderNo,a.orderDate
	    FROM ems_order a,sys_userstore b
		where a.store_id=b.store_id and b.user_id=#{user_id} and b.edit='Y' and a.ordernum!=a.totalnum
		order by a.orderDate desc
    </select>-->
    
    <!-- 获取某个订单的状态 -->
    <select id="queryStatus" resultType="string" parameterType="String">
    	SELECT a.status
	    FROM ems_order a
		where a.id=#{id}
    </select>
    
   
    
    <!--a0.status作为Equipment的状态 ,在新品入库的时候，查询设备条码用的-->
    <select id="getEquipFromBarcode" resultType="com.mawujun.baseinfo.EquipmentVO" parameterType="String">
    	select a0.ecode,a0.orderlist_id,a0.status,
    	a.store_id,
		a.brand_id,
		a.prod_id,
		a.style,
		a.subtype_id,
		a.supplier_id,
		a.type_id,
		a.unitprice
		,b.name as subtype_name,c.name as prod_name,c.spec as prod_spec,d.name as brand_name,e.name as supplier_name
		from ems_barcode a0 
		inner join (select a.*,b.store_id from ems_orderlist a,ems_order b where a.order_id=b.id) a on a0.orderlist_id=a.id 
		inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		where a0.ecode=#{ecode}  
    </select>

	<!--更新订单明细中，已经入库的数量 -->
	<select id="updateTotalNum">
    	update ems_orderlist 
    	set totalNum=${totalNum}
    	where id=#{orderlist_id}
    </select> 
    
    
	<!-- 打印条码的时候，获取要打印的范围 
	select a.style,b.ecode from ems_Order a,ems_Barcode b 
    	where a.id=b.order_id and a.id=#{order_id} and b.seqnum &gt; #{startNum} and b.seqnum &lt;= #{endNum}
	-->    
    <select id="getBarcodesRange" resultType="com.mawujun.store.BarcodeVO" parameterType="map">
    	
    	
    	SELECT a.*,b.name as subtype_name,c.name as prod_name,d.name as brand_name,e.name as supplier_name,f.ecode
	    FROM ems_orderlist a
	    inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		inner join ems_Barcode f on a.id=f.orderlist_id and f.seqnum &gt; #{startNum} and f.seqnum &lt;= #{endNum}
		where a.id=#{orderlist_id}   
    </select>
    
    <!-- 获取订单的主信息，就是 明细表对应主表的信息 ,当字段发生变化的时候要注意OrderService
    <select id="getMainInfo" resultType="com.mawujun.store.Order" parameterType="map">
    	select distinct orderNo,store_id,orderDate,operater,status,createDate from ems_Order a
    	where a.orderNo=#{orderNo}
    </select>-->
</mapper>

