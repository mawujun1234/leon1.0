<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!-- mawujun qq:16064988 e-mail:16064988@qq.com-->
<mapper namespace="com.mawujun.mobile.task.TaskRepository">
	<select id="queryPoles" resultType="com.mawujun.baseinfo.PoleVO" parameterType="map">
    	select 
		a.*,
		b.name as area_name,
		c.id as workunit_id,
		c.name as workunit_name,
		d.name as customer_name,
		e.id as task_id,
		e.type as task_type,
		e.status as task_status,
		e.memo as task_memo
		from EMS_pole a 
		inner join ems_area b on  a.area_id=b.id
		inner join Ems_Workunit c on b.workunit_id=c.id
		inner join ems_customer d on a.customer_id=d.id
		left join ems_task e on a.id=e.pole_id and e.status!='complete'
		<where>
			<if test="customer_id!=null">
				and a.customer_id=#{customer_id}
			</if>
			<if test="area_id!=null">
				and a.area_id=#{area_id}
			</if>
			<if test="workunit_id!=null">
				and b.workunit_id=#{workunit_id}
			</if>
			<if test="pole_name!=null">
				and a.name like #{pole_name}
			</if>
		</where>
    </select>
    
    <select id="queryPage" resultType="com.mawujun.mobile.task.Task" parameterType="map">
    	select * from ems_task a
    	<where>
			<if test="customer_id!=null">
				and a.customer_id=#{customer_id}
			</if>
			<if test="status!=null">
				and a.status=#{status}
			</if>
			<if test="workunit_id!=null">
				and a.workunit_id=#{workunit_id}
			</if>
			<if test="pole_name!=null">
				and a.pole_name like #{pole_name}
			</if>
		</where>
    </select>
    
    
    <select id="mobile_queryPage" resultType="com.mawujun.mobile.task.Task" parameterType="map">
    	select * from ems_task a
    	where a.workunit_id=#{workunit_id}
    	<if test="status=='working'">
    		and a.status in ('newTask','read','handling')
    	</if>
    	<if test="status=='confirm'">
    		and a.status ='submited'
    	</if>
    	<if test="status=='complete'">
    		and a.status ='complete'
    	</if>
    </select>
    
    
    <select id="mobile_queryTaskEquipmentInfos" resultType="com.mawujun.baseinfo.EquipmentVO" >
    	select a.*,b.text as subtype_name,c.text as prod_name,d.name as brand_name,e.name as supplier_name from ems_equipment a
		inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		inner join ems_taskequipmentlist f on a.ecode=f.ecode and f.task_id=#{task_id}
    </select> 
</mapper>

