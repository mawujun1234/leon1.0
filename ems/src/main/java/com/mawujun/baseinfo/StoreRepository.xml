<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!-- mawujun qq:16064988 e-mail:16064988@qq.com-->
<mapper namespace="com.mawujun.baseinfo.StoreRepository">
	<!-- 库存查询的功能，第一级的时候 -->
	<select id="queryEquipments_total" resultType="com.mawujun.baseinfo.EquipmentVO" parameterType="com.mawujun.baseinfo.Equipment">
    	select a.subtype_id,a.prod_id,b.name as subtype_name,c.name as prod_name,sum(a.num) as num
	      from 
	      (select x.*,1 as num from ems_equipment x where x.store_id=#{store_id}) a
	    inner join ems_equipmentsubtype b on a.subtype_id=b.id
			inner join ems_equipmentprod c on a.prod_id=c.id
			inner join ems_brand d on a.brand_id=d.id
			inner join ems_supplier e on a.supplier_id=e.id
		<where>
			<if test="subtype_id!=null and subtype_id!=''">
				and b.id=#{subtype_id}
			</if>
			<if test="prod_id!=null and prod_id!=''">
				and c.id=#{prod_id}
			</if>
			<if test="brand_id!=null and brand_id!=''">
				and d.id=#{brand_id}
			</if>
			<if test="supplier_id!=null and supplier_id!=''">
				and e.id=#{supplier_id}
			</if>
		</where>
		 group by a.subtype_id,a.prod_id,b.name,c.name
    </select> 
    <!-- 库存查询的功能 ，第二辑和第三级-->
    <select id="queryEquipments" resultType="com.mawujun.baseinfo.EquipmentVO" parameterType="com.mawujun.baseinfo.EquipmentVO">
    	select a.subtype_id,a.prod_id,
    	<if test="prod_id!=null and prod_id!=''">
				a.ecode,
		</if>
    	a.style,b.name as subtype_name,c.name as prod_name,c.spec as prod_spec,d.name as brand_name,e.name as supplier_name ,sum(a.num) as num
    	from (select x.*,1 as num from ems_equipment x where x.store_id=#{store_id} and x.subtype_id=#{subtype_id}) a 
		inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		<where>
			<!-- <if test="subtype_id!=null and subtype_id!=''">
				and b.id=#{subtype_id}
			</if> -->
			<if test="prod_id!=null and prod_id!=''">
				and c.id=#{prod_id}
			</if>
			<if test="style!=null and style!=''">
				and a.style=#{style}
			</if>
			<if test="brand_id!=null and brand_id!=''">
				and d.id=#{brand_id}
			</if>
			<if test="supplier_id!=null and supplier_id!=''">
				and e.id=#{supplier_id}
			</if>
		</where>
		 group by a.subtype_id,a.prod_id,
		 <if test="prod_id!=null and prod_id!=''">
				a.ecode,
		 </if>
		 a.style,b.name ,c.name,c.spec,d.name,e.name
    </select> 
    <select id="queryEquipments_count" resultType="int" parameterType="com.mawujun.baseinfo.EquipmentVO">
		select count(x.ecode) from ems_equipment x where x.store_id=#{store_id} and x.subtype_id=#{subtype_id}
			<!--<if test="subtype_id!=null and subtype_id!=''">
				and x.subtype_id=#{subtype_id}
			</if> -->
			<if test="prod_id!=null and prod_id!=''">
				and x.prod_id=#{prod_id}
			</if>
			<if test="style!=null and style!=''">
				and x.style=#{style}
			</if>
			<if test="brand_id!=null and brand_id!=''">
				and x.brand_id=#{brand_id}
			</if>
			<if test="supplier_id!=null and supplier_id!=''">
				and x.supplier_id=#{supplier_id}
			</if>
    </select> 
    
    
    <select id="queryCombo" resultType="com.mawujun.baseinfo.Store" parameterType="map" >
    	select a.* from ems_store a,sys_userstore b where a.id=b.store_id and b.user_id=#{user_id} and a.status='Y' 
    	and a.type in
		<foreach collection="types" item="item" index="index" open="(" separator="," close=")" >
            #{item}
		</foreach>
    	<if test="look==true">
    		and b.look='Y'
    	</if>
    	<if test="edit==true">
    		and b.edit='Y'
    	</if>
    	<if test="edit!=true and look!=true">
    		and 1!=1
    	</if>
    	 
    </select>
    
    <select id="queryUsersByStore" resultType="com.mawujun.baseinfo.Store">
    	select a.* from sys_user a,sys_userstore b 
    	where a.id=b.user_id and b.store_id=#{store_id} and a.status='Y'
    	<if test="look==true">
    		and b.look='Y'
    	</if>
    	<if test="edit==true">
    		and b.edit='Y'
    	</if>
    	<if test="edit!=true and look!=true">
    		and 1!=1
    	</if>
    </select>
   
</mapper>

