<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<!-- mawujun qq:16064988 e-mail:16064988@qq.com-->
<mapper namespace="com.mawujun.baseinfo.WorkUnitRepository">
	<!-- <select id="queryEquipments" resultType="com.mawujun.baseinfo.EquipmentVO" parameterType="java.lang.String">
    	select a.*,b.name as subtype_name,c.name as prod_name,d.name as brand_name,e.name as supplier_name 
    	from (select x.* from ems_equipment x where x.workUnit_id=#{workUnit_id}) a
		inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
    </select> 
     -->
    <select id="queryEquipments_total" resultType="com.mawujun.baseinfo.EquipmentVO" parameterType="com.mawujun.baseinfo.Equipment">
    	select a.subtype_id,b.name as subtype_name,sum(a.num) as num
    	from (select x.*,1 as num from ems_equipment x,ems_equipment_workunit y where x.ecode=y.ecode and y.workUnit_id=#{workUnit_id}) a
		inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		<where>
			<if test="subtype_id!=null and subtype_id!=''">
				and b.id=#{subtype_id}
			</if>
			<if test="brand_id!=null and brand_id!=''">
				and d.id=#{brand_id}
			</if>
			<if test="supplier_id!=null and supplier_id!=''">
				and e.id=#{supplier_id}
			</if>
		</where>
		 group by a.subtype_id,b.name
    </select> 
    <select id="queryEquipments" resultType="com.mawujun.baseinfo.EquipmentVO" parameterType="java.lang.String">
    	select a.subtype_id,a.prod_id,
    	<if test="prod_id!=null and prod_id!=''">
				a.ecode,
		</if>
    	a.style,b.name as subtype_name,c.name as prod_name,c.spec as prod_spec,d.name as brand_name,e.name as supplier_name ,sum(a.num) as num
    	from (select x.*,1 as num from ems_equipment x ,ems_equipment_workunit y where x.ecode=y.ecode and y.workUnit_id=#{workUnit_id} and x.subtype_id=#{subtype_id}) a
		inner join ems_equipmentsubtype b on a.subtype_id=b.id
		inner join ems_equipmentprod c on a.prod_id=c.id
		inner join ems_brand d on a.brand_id=d.id
		inner join ems_supplier e on a.supplier_id=e.id
		<where>
			<!-- <if test="subtype_id!=null and subtype_id!=''">
				and b.id=#{subtype_id}
			</if> -->
			<if test="prod_id!=null and prod_id!=''">
				and c.id=#{prod_id}
			</if>
			<if test="style!=null and style!=''">
				and a.style=#{style}
			</if>
			<if test="brand_id!=null and brand_id!=''">
				and d.id=#{brand_id}
			</if>
			<if test="supplier_id!=null and supplier_id!=''">
				and e.id=#{supplier_id}
			</if>
		</where>
		 group by a.subtype_id,a.prod_id,
		 <if test="prod_id!=null and prod_id!=''">
				a.ecode,
		 </if>
		 a.style,b.name ,c.name,c.spec,d.name,e.name
    </select> 
    <select id="queryEquipments_count" resultType="int" parameterType="com.mawujun.baseinfo.EquipmentVO">
		select count(x.ecode) from ems_equipment x ,ems_equipment_workunit y where x.ecode=y.ecode and y.workUnit_id=#{workUnit_id} and x.subtype_id=#{subtype_id}
			<!--<if test="subtype_id!=null and subtype_id!=''">
				and x.subtype_id=#{subtype_id}
			</if> -->
			<if test="prod_id!=null and prod_id!=''">
				and x.prod_id=#{prod_id}
			</if>
			<if test="style!=null and style!=''">
				and x.style=#{style}
			</if>
			<if test="brand_id!=null and brand_id!=''">
				and x.brand_id=#{brand_id}
			</if>
			<if test="supplier_id!=null and supplier_id!=''">
				and x.supplier_id=#{supplier_id}
			</if>
    </select> 
    
    <!-- 移动端使用 -->
    <select id="queryHaveEquipmentInfosTotal" resultMap="EquipmentSubtype_Map" parameterType="java.lang.String">
    	select a.subtype_id,b.name as subtype_name,c.id as prod_id,c.name as prod_name,c.style as prod_style,count(a.ecode) ecode_num
      	from (select x.* from ems_equipment x ,ems_equipment_workunit y where x.ecode=y.ecode and y.workUnit_id=#{workUnit_id}) a
	    inner join ems_equipmentsubtype b on a.subtype_id=b.id
	    inner join ems_equipmentprod c on a.prod_id=c.id
	    group by  a.subtype_id ,b.name,c.id,c.name,c.style
	    order by  a.subtype_id,c.id
    </select>
    <resultMap id="EquipmentSubtype_Map" type="com.mawujun.baseinfo.EquipmentSubtype" >
     	<id property="id" column="subtype_id"/>
    	<result property="name" column="subtype_name"/>
    	<collection property="prodes" ofType="com.mawujun.baseinfo.EquipmentProdVO">  
            <id property="id" column="prod_id"/>
		   <result property="name" column="prod_name"/>
		   <result property="style" column="prod_style"/>
		   <result property="ecode_num" column="ecode_num"/>
       </collection>  
    </resultMap>
    
    <select id="queryHaveEquipmentInfosDetail" resultType="com.mawujun.baseinfo.EquipmentVO">
    	select a.ecode,d.name as brand_name 
    	from (select x.* from ems_equipment x ,ems_equipment_workunit y where x.ecode=y.ecode and y.workUnit_id=#{workUnit_id} and prod_id=#{prod_id}) a
		inner join ems_brand d on a.brand_id=d.id
		order by d.name
    </select> 
   
   <!-- 查询某个作业单位下的点位 -->
    <select id="queryPoles" resultType="com.mawujun.baseinfo.Pole" parameterType="map">
    	SELECT a.*
	    FROM ems_pole a
		where a.workunit_id=#{workunit_id}
		<if test="customer_id!=null and customer_id!=''">
			 and a.customer_id=#{customer_id}
		</if>
		order by a.code asc
    </select>
    <update id="savePoles">
	  	update ems_pole set workunit_id=#{workunit_id} where id=#{pole_id}
	</update>
	<update id="deletePoles">
	  	update ems_pole set workunit_id=null where id=#{pole_id}
	</update>
	
	<select id="queryByUser" resultType="com.mawujun.baseinfo.WorkUnitVO" parameterType="map">
    	SELECT a.*,decode(c.user_id,null,'N','Y') selected
	    FROM ems_workunit a
	    left join sys_user_workunit c on a.id=c.workunit_id and c.user_id=#{user_id}
	    
    </select>
</mapper>

